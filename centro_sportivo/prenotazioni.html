<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>PAGINA DI PRENOTAZIONI</h1>
    <button onclick="prenotaCampo(dataGiorno)">PRENOTA UN CAMPO</button>
    <label for="orarioSelect">Seleziona orario:</label>
    <select id="orarioSelect" onchange="selezionaFine(this.value)">
        <!-- Opzioni del select verranno popolate dinamicamente -->
    </select>
    <label for="orarioSelectFinish">Seleziona orario di fine:</label>
    <select id="orarioSelectFinish">
        <!-- Opzioni del select verranno popolate dinamicamente -->
    </select>

    
    <p>nel seguente giorno sono state effettuate le seguenti preotazioni</p>



    <script>
        async function prenotaCampo(dataGiorno){
            var orarioInizio = document.getElementById("orarioSelect").value;
            var orarioFine = document.getElementById("orarioSelectFinish").value;

            const dataToSend = {
                orarioInizio: orarioInizio,
                orarioFine: orarioFine,
                anno: dataGiorno["anno"],
                mese: dataGiorno["mese"],
                giorno: dataGiorno["giorno"]
                
            }
            
            console.log(dataToSend);
            try {
            const response = await fetch('addPrenotazioneCalcetto.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', // Specifica il tipo di contenuto come JSON
                    // Altri eventuali header necessari possono essere aggiunti qui
                },
                body: JSON.stringify(dataToSend), // Converte i dati in formato JSON
            });

            // Gestione degli errori HTTP
            if (!response.ok) {
                throw new Error(`Errore durante la richiesta al server. Codice di stato: ${response.status}`);
            } 
   
            reciveDataFromServer(dataGiorno);
 

             } catch (error) {
            console.error('Errore nella fetch:', error.message);
            }
        }
        async function reciveDataFromServer(dataGiorno){
                const dataToSend2 = {
                    anno: dataGiorno["anno"],
                    mese: dataGiorno["mese"],
                    giorno: dataGiorno["giorno"]
            }
            console.log(dataToSend2);

            try {
            const response = await fetch('backendCalcetto.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', // Specifica il tipo di contenuto come JSON
                    // Altri eventuali header necessari possono essere aggiunti qui
                },
                body: JSON.stringify(dataToSend2), // Converte i dati in formato JSON
            });

            // Gestione degli errori HTTP
            if (!response.ok) {
                throw new Error(`Errore durante la richiesta al server. Codice di stato: ${response.status}`);
            }

            // Controllo del tipo di contenuto
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const responseData = await response.json();
                if (responseData.length === 0) {
                        console.log('In questo giorno non sono state effettuate prenotazioni');
                    } else {
                        console.log('Dati ricevuti dal server:', responseData);
                        $responseArray = responseData;
                        console.log($responseArray);
                        $stringaJSON = JSON.stringify($responseArray);
                        sessionStorage.setItem('responseArray', $stringaJSON);
                        // Dopo aver ottenuto i dati dal server
                        location.reload();
                    }
            } else {
                console.error('La risposta non contiene dati JSON');
            }

            } catch (error) {
            console.error('Errore nella fetch:', error.message);
            }
        };

        function createPage(dataGiorno){
            let responseData = "";
            // Recupera i dati memorizzati nel sessionStorage
            const responseArrayJSON = sessionStorage.getItem('responseArray');
            const responseArray = JSON.parse(responseArrayJSON);
            
            // Fai qualcosa con i dati...
            console.log(responseArray);
            console.log(dataGiorno);

            responseArray.forEach(element => {
                document.write("<p> Campo prenotato: " + element['nomeCampo'] + " dalle " + element['oraInizio'] + " alle " + element['oraFine'] + "</p>");
            });

            // Utilizza una promessa per garantire l'esecuzione di popolaOrari dopo il completamento del forEach
            new Promise((resolve, reject) => {
                // Esegui il resolve() dopo aver completato il forEach
                resolve();
            }).then(() => {
                // Esegui popolaOrari(dataGiorno) dopo il completamento del forEach
                popolaOrari(dataGiorno);
        });
    }

         
        async function popolaOrari(dataGiorno) {
            const dataToSend = {
                anno: dataGiorno["anno"],
                mese: dataGiorno["mese"],
                giorno: dataGiorno["giorno"]
            }
            
            console.log(dataToSend);

            try {
            const response = await fetch('backendOrariCalcetto.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', // Specifica il tipo di contenuto come JSON
                    // Altri eventuali header necessari possono essere aggiunti qui
                },
                body: JSON.stringify(dataToSend), // Converte i dati in formato JSON
            });

            // Gestione degli errori HTTP
            if (!response.ok) {
                throw new Error(`Errore durante la richiesta al server. Codice di stato: ${response.status}`);
            } 

            // Controllo del tipo di contenuto
             const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                responseData = await response.json();
                console.log(responseData);
                // Popola le opzioni della select con i risultati della fetch
                const select = document.getElementById('orarioSelect');
                select.innerHTML = ''; // Pulisce le opzioni precedenti

                // Itera sull'array associativo e aggiungi le ore disponibili come opzioni della select
                responseData["merged_result"].forEach(ora => {
                    const option = document.createElement('option');
                    option.textContent = ora.ora; // Assumi che l'oggetto abbia una proprietà 'ora'
                    select.appendChild(option);
            });
                
            } else {
                console.error('La risposta non contiene dati JSON');
            } 

             } catch (error) {
            console.error('Errore nella fetch:', error.message);
            }
    }; 
        function selezionaFine(orarioSelezionato){
        var date = [];
        var opzioni = document.getElementById("orarioSelect").options;
        for (var i = 0; i < opzioni.length; i++) {
            date.push(opzioni[i].value); 
            console.log(opzioni[i].value);
            console.log(date);
        }
        
        const selectFine = document.getElementById("orarioSelectFinish");
        selectFine.innerHTML = '';
        let isPresent;
        let newTime = orarioSelezionato;
        
            do{
            isPresent = false;
            // Converti l'orario in secondi
            var timeParts = newTime.split(':');
            var seconds = (+timeParts[0]) * 3600 + (+timeParts[1]) * 60 + (+timeParts[2]);

            // Aggiungi 30 minuti (1800 secondi)
            seconds += 1800;

            // Converti nuovamente i secondi in formato di orario
            var hours = Math.floor(seconds / 3600);
            var minutes = Math.floor((seconds - (hours * 3600)) / 60);
            var secs = seconds - (hours * 3600) - (minutes * 60);

            // Formatta il risultato
            newTime = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
            const option = document.createElement('option');
            option.textContent = newTime; // Assumi che l'oggetto abbia una proprietà 'ora'
            selectFine.appendChild(option);
            console.log("Nuovo orario:", newTime);

            for(let i = 0; i < date.length; i++){
                if (date[i] == newTime) {
                    isPresent = true;
                    break;
                }
            
            }}while(isPresent) 
    } 
    const dataGiornoJSON = sessionStorage.getItem('dataGiornoSelected');
    const dataGiorno = JSON.parse(dataGiornoJSON);
    createPage(dataGiorno);

   
    </script>
</body>
</html>